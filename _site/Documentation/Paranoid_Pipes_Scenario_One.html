<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link rel="stylesheet" href="/assets/css/style.css?v=0c3df73b4b0f422ddbf3bcf68ad33f41f6f353e2">
    <title>Perinoid_Pipes by S0AndS0</title>
  </head>

  <body>

    <header>
      <div class="container">
        <h1>Perinoid_Pipes</h1>
        <h2>Where named pipes are used for encryption</h2>

        <section id="downloads">
          
          <a href="http://github.com/S0AndS0/Perinoid_Pipes" class="btn btn-github"><span class="icon"></span>View on GitHub</a>
        </section>
      </div>
    </header>

    <div class="container">
      <section id="main_content">
        <h1 id="scenario-one">Scenario one</h1>

<blockquote>
  <p><code class="highlighter-rouge">Logging output</code> -&gt; <code class="highlighter-rouge">Pipe (encryption) input</code> -&gt; <code class="highlighter-rouge">Encrypted log output</code> -&gt;
<code class="highlighter-rouge">Rotate using encrypted email and compression</code></p>
</blockquote>

<p>This scenario was written with the following link’s questions as it’s
 inspiration Serverfault
 <a href="http://serverfault.com/questions/89126/asymmetrically-encrypted-filesystem">Asymmetric encrypt server logs that end up with sensitive data written to them</a></p>

<hr />

<h2 id="quote-begin">Quote begin</h2>

<blockquote>
  <p>I’m dealing with some data that’s governed by specific regulations and that
must be handled in a specific manner.
I’m finding that this data ends up in some of my log files as a result of the
system operating as intended. I’d like to find a way to log messages on the
server that receives that date, but to do so in such a way that the data is
encrypted as it’s written to disk and may not be decrypted by that same server.</p>
</blockquote>

<h2 id="quote-cut-off">Quote cut-off</h2>

<hr />

<blockquote>
  <p>As of the time of writing this document both the authors of this project and
the author of the above question have not found a suitable solution; aside from
the following command line options being used on the project’s script that is…</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>./Paranoid_Pipes.sh\
 --enc-copy-save-yn='yes'\
 --enc-copy-save-path="/jailer_scripts/website_host/Web_log_encrypter.sh"\
 --enc-copy-save-ownership="notwwwuser:notwwwgroup"\
 --enc-copy-save-permissions='100'\
 --debug-level='6'\
 --enc-parsing-quit-string='sOmErAnDoM_sTrInG_wItHoUt_SpAcEs_tHaT_iS_nOt_NoRmAlY_rEaD'\
 --log-level='0'\
 --enc-pipe-file="/jailed_servers/website_host/var/log/www/access.log.pipe"\
 --enc-pipe-ownership='notwwwuser:wwwgroup'\
 --enc-pipe-permissions='420'\
 --enc-parsing-output-file="/jailed_logs/website_host/www_access.gpg"\
 --enc-parsing-recipient="user@host.domain"\
 --enc-parsing-output-rotate-actions='compress-encrypt,remove-old'\
 --enc-output-rotate-check-requency='25000'\
 --enc-parsing-output-max-size='8388608'\
 --enc-parsing-output-rotate-recipient="user@host.domain"\
 --enc-parsing-output-rotate-yn='yes'\
 --enc-parsing-save-output-yn='yes'\
 --enc-parsing-disown-yn='yes' --help
 --enc-parsing-bulk-out-dir="/server/backups/website_host"
</code></pre>
</div>

<blockquote>
  <p>Note, if you’ve setup the web server within a chroot (as is assumed by
example values) then future attackers will not see your server’s log data
from previous connections, instead they’ll see a named pipe that they can not
write to unless they’re the same <code class="highlighter-rouge">group</code> as that that preforms normal log
writes. Nor will future attackers gain access to the encrypted logs until
they’ve broken out of the server’s jail. Even then the encrypted logs should
be useless to them so long as the private key is <strong>not</strong> also stored on the
host.</p>
</blockquote>

<h3 id="summery-of-logging-data-flow">Summery of logging data flow</h3>

<ol>
  <li>
    <p>Client interacts with server such that logs are generated. Modify the server
 or daemon to use the same file path as defined by <code class="highlighter-rouge">--enc-pipe-file</code> option
 for output of it’s logs.</p>
  </li>
  <li>
    <p>Written data to named pipe is read by Bash loops contained in customized
 script copy defined by <code class="highlighter-rouge">--enc-copy-save-path</code> option.</p>
  </li>
  <li>
    <p>Using public key defined by <code class="highlighter-rouge">--output-parse-recipient</code> option, every data
 block read by the script copy will be encrypted. Note this script is capable
 of reading multi-line writes to it’s named pipe in a single operation, thus if
 your logging daemon or server writes multiple lines per client interaction
 then the entire write action is captured up to a few thousand lines at a time.</p>
  </li>
  <li>
    <p>The encrypted data is then saved (appended) to file defined by
 <code class="highlighter-rouge">--enc-parsing-output-file</code> option and the Bash loop checks it’s internal write
 count against the count defined by <code class="highlighter-rouge">--enc-parsing-output-check-frequency</code> option
 and usually restarts processes that listen to named pipe for more writes.</p>
  </li>
</ol>

<blockquote>
  <p>If the internal write count matches that of
<code class="highlighter-rouge">--enc-parsing-output-check-frequency</code> or is greater then the
<code class="highlighter-rouge">--enc-parsing-output-max-size</code> value is used to check the encrypted log file size.
If the encrypted log file size matches that of <code class="highlighter-rouge">--enc-parsing-output-max-size</code>
or is greater then the actions defined by <code class="highlighter-rouge">--enc-parsing-output-rotate-actions</code> option is
considered.
Note the more actions listed in the <code class="highlighter-rouge">--enc-parsing-output-rotate-actions</code> option the
longer that the named pipe will be blocked for writing/parsing actions.
Note if your server has <code class="highlighter-rouge">mutt</code> installed and configured to send emails you
may wish to use the following instead. Additionally when emailed log rotation
is enabled it will be the address defined by <code class="highlighter-rouge">--enc-parsing-output-rotate-recipient</code>
option that receives attached encrypted logs.</p>
</blockquote>

<h2 id="enable-emailed-log-rotation-instead">Enable emailed log rotation instead</h2>

<div class="highlighter-rouge"><pre class="highlight"><code>--enc-parsing-output-rotate-actions='encrypted-email,remove-old'
</code></pre>
</div>

<blockquote>
  <p>If no line matches <code class="highlighter-rouge">--enc-parsing-quit-string</code> option then reading named pipe
for write actions from server or logging daemon is resumed and step <code class="highlighter-rouge">1</code>
above starts again.</p>
</blockquote>

<h3 id="what-does-the-other-above-options-do">What does the other above options do</h3>

<h4 id="enable-saving-script-copy-saving-operation">Enable saving script copy saving operation</h4>

<blockquote>
  <p>all customized options are then saved by the main script to the script copy
saved to the path defined by <code class="highlighter-rouge">--enc-copy-save-path</code> option.</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>--enc-copy-save-yn='yes'
</code></pre>
</div>

<h4 id="the-usergroup-allowed-to-run-script-copy">The <code class="highlighter-rouge">&lt;user&gt;:&lt;group&gt;</code> allowed to run script copy</h4>

<blockquote>
  <p>This should be a <strong>non</strong>-root and/or <strong>non</strong>-sudo user group combo because
it’ll be parsing logs generated by the web server and thus unknown clients
with unknown motives.</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>--enc-copy-save-ownership="notwwwuser:notwwwgroup"
</code></pre>
</div>

<h4 id="set-execute-permissions-for-script-owner-only">Set execute permissions for script owner only</h4>

<blockquote>
  <p>Once written it should not be modifiable by any user other than a root/sudo
user capable of running
<code class="highlighter-rouge">su -u notwwuser -c "/jailer_scripts/website_host/Web_log_encrypter.sh"</code>.</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>--enc-copy-save-permissions='100'
</code></pre>
</div>

<h4 id="set-debug-levels-really-high">Set debug levels really high</h4>

<blockquote>
  <p>all saving script operations are shown. Note setting this level equal to or
higher than <code class="highlighter-rouge">3</code> will cause the main script to prompt to continue, this is
normal and a requires a <code class="highlighter-rouge">yes</code> like response to continue.</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>--debug-level='6'
</code></pre>
</div>

<h4 id="set-log-level-to-lowest-value-possible-value">Set log level to lowest value possible value</h4>

<blockquote>
  <p>avoids writing anything unintentional to host system. If instead a log of
every message passed is desired then use n+1, where <code class="highlighter-rouge">n</code> is the level chosen
above with <code class="highlighter-rouge">--debug-level</code> option, ei <code class="highlighter-rouge">7</code> to capture every message from above
example to a log file.</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>--log-level='0'
</code></pre>
</div>

<h4 id="the-user-allowed-to-read-from-above-pipe-file-name">The <code class="highlighter-rouge">User</code> allowed to read from above pipe file name</h4>

<blockquote>
  <p>and the <code class="highlighter-rouge">Group</code> allowed to write to named pipe file. Tip the owner in bellow
should be the same as the script copy’s owner and the group should be the same
as one that the chrooted web server’s logger is apart of.</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>--enc-pipe-ownership='notwwwuser:wwwgroup'
</code></pre>
</div>

<h4 id="read-and-write-permissions">Read and write permissions</h4>

<blockquote>
  <p>that support the above ownership split that would be readable by the script
copy’s owner, writable by logging group, and nothing more.</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>--enc-pipe-permissions='420'
</code></pre>
</div>

<blockquote>
  <p>The combination of these above ownership and permission options <strong>must</strong>
be correct for the target server or either; the logging service will be unable
to write to the named pipe file, or the script copy will be unable to read
from the named pipe.
Tip: <code class="highlighter-rouge">ls -hal /path/to/standard.log</code> will reveal the <code class="highlighter-rouge">user</code> and <code class="highlighter-rouge">group</code>
that the target server currently uses, make use of the old log file’s
<code class="highlighter-rouge">group</code>’s permissions for defining the above command line <code class="highlighter-rouge">wwwgroup</code> value.</p>
</blockquote>

<h4 id="cause-script-once-written-to-be-run-in-the-background">Cause script, once written, to be run in the background</h4>

<blockquote>
  <p>Note this uses (internally called) <code class="highlighter-rouge">disown</code> command. This option is the last
in above example options that will be written to the script copy.</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>--enc-parsing-disown-yn='yes'
</code></pre>
</div>

<h4 id="printing-set-options--exit-without-writing-scirpt-copy">Printing set options &amp; exit without writing scirpt copy</h4>

<blockquote>
  <p>Remove this option after reviewing that options are set for your needs and
the script will be saved and started prior to the main script exiting.</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>--help
</code></pre>
</div>

<blockquote>
  <p>Last steps are to configure the target server or log daemon to start writing
to the above named pipe instead of their default locations; note if using a
log daemon such as <code class="highlighter-rouge">rsyslog</code> then for testing you may wish to have logs
written to both default location and new named pipe location. For servers such
as Nginx and other web servers be sure to check the documentation for
“Log Rotation” for how to properly restart the related server’s logging. Next
sets of links are what this document’s author could find for proper server
restart signals; hint nginx is easiest.
Web Server : <a href="https://www.nginx.com/resources/wiki/start/topics/examples/logrotation/">Nginx log rotation documentation</a>
Modify virtual host log access and log error lines to point to related named
pipes, then use the following <code class="highlighter-rouge">kill</code> signal to restart the server’s logging.
Note <code class="highlighter-rouge">master.nginx.pid</code> should contain the full file path if not within Nginx’s
configuration directory.</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>kill -USR1 $(cat master.nginx.pid)
</code></pre>
</div>

<ul>
  <li>Apache v2.4 <a href="https://httpd.apache.org/docs/2.4/programs/rotatelogs.html">log rotation documentation</a></li>
  <li>Rsyslog v8<code class="highlighter-rouge">ompipe</code> <a href="http://www.rsyslog.com/doc/v8-stable/configuration/modules/ompipe.html">plug-in documentation</a></li>
</ul>

<h4 id="automation-of-named-pipe-log-encryption-for-nginx">Automation of named pipe log encryption for nginx</h4>

<blockquote>
  <p>Add the following line just before <code class="highlighter-rouge">daemon-start-stop</code> line under web
server’s start action; on Debian based systems this is usually under
<code class="highlighter-rouge">/etc/init.d/nginx</code> file path.</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>/jailer_scripts/website_host/Web_log_encrypter.sh
</code></pre>
</div>

<blockquote>
  <p>Add the following just after <code class="highlighter-rouge">daemon-start-stop</code> line under web server’s
stop action.</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>echo 'sOmErAnDoM_sTrInG_wItHoUt_SpAcEs_tHaT_iS_nOt_NoRmAlY_rEaD' &gt; /jailed_servers/website_host/var/log/www/access.log.pipe
</code></pre>
</div>

<blockquote>
  <p>Test that all still works as desired by restarting the server with the
following series of commands.</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>/etc/init.d/nginx stop &amp;&amp;\
 /etc/init.d/nginx start &amp;&amp;\
 tail -f /jailed_logs/website_host/www_access.gpg
</code></pre>
</div>

<p>After clients reconnect you’ll see the <code class="highlighter-rouge">~.gpg</code> logs start filling up, use
 <code class="highlighter-rouge">Ctrl^c</code> keyboard short-cut to exit tail command and wait for emails to start
 rolling into the log rotation email’s inbox.</p>

<blockquote>
  <p>Now at some point in the future you or your web-admin will need access to the
logs, first decrypt the rolled logs with the second key used to encrypt them
and then have your web-admin run something like the following to have
encrypted data <em>chunks</em> shoved through decryption commands.</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>./Paranoid_Pipes.sh\
 --debug-level="9"\
 --dec-yn="yes"\
 --dec-parsing-disown-yn="no"\
 --dec-bulk-check-sleep="2"\
 --dec-bulk-check-count-max='1'\
 --dec-pass="/path/to/passphrase.file"\
 --dec-parsing-save-output-yn="yes"\
 --dec-parsing-output-file="/path/to/decrypted.log"\
 --enc-parsing-output-file="/jailed_logs/website_host/www_access.gpg"\
 --dec-parsing-bulk-out-dir="/path/to/decrypted/backups"\
 --enc-parsing-bulk-out-dir="/server/backups/website_host"
</code></pre>
</div>

<blockquote>
  <p>This portion of the main script maybe verified by checing logs for
<a href="../.travis-ci/version_two_last_tests.sh">version_two_last_tests.sh</a>
and used by your decrypting server to accomplish this goal. Which should (for
medium to small log files) pull each encrypted section within a previously
appended to encrypted log file out into an array of arrays, then push those
arrays one by one through either; decryption command &amp; out to clear text file,
or, if a pipe is detected as above script’s output path then the compound array
will dump there instead and it’ll be up to the listening pipe’s script to output
to it’s destination. This allows, with proper custom settings, for piping
through search parameters that save only relevant or requested information to a
clear text file while ignoring everything else.</p>
</blockquote>

<h2 id="licensing-notice-for-this-file">Licensing notice for this file</h2>

<div class="highlighter-rouge"><pre class="highlight"><code>    Copyright (C) 2016 S0AndS0.
    Permission is granted to copy, distribute and/or modify this document under
    the terms of the GNU Free Documentation License, Version 1.3 published by
    the Free Software Foundation; with the Invariant Sections being
    "Title page". A copy of the license is included in the directory entitled
    "License".
</code></pre>
</div>

<p><a href="/Documentation/Contributing_Financially.html">Link to title page</a></p>

<p><a href="/Licenses/GNU_FDLv1.3_Documentation.html">Link to related license</a></p>

      </section>
    </div>

    
  </body>
</html>
