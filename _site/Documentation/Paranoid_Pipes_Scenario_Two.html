<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link rel="stylesheet" href="/assets/css/style.css?v=6b26304f89141400512e932cdbdd42dbdc347ad2">
    <title>Perinoid_Pipes by S0AndS0</title>
  </head>

  <body>

    <header>
      <div class="container">
        <h1>Perinoid_Pipes</h1>
        <h2>Where named pipes are used for encryption</h2>

        <section id="downloads">
          
          <a href="http://github.com/S0AndS0/Perinoid_Pipes" class="btn btn-github"><span class="icon"></span>View on GitHub</a>
        </section>
      </div>
    </header>

    <div class="container">
      <section id="main_content">
        <h1 id="scenario-two">Scenario two</h1>

<hr />

<blockquote>
  <p><code class="highlighter-rouge">Logging output</code> -&gt; <code class="highlighter-rouge">Pipe (encryption) input</code> -&gt; <code class="highlighter-rouge">Encryption</code> -&gt;
<code class="highlighter-rouge">Pipe (decryption) input</code> -&gt; <code class="highlighter-rouge">Log output (rotate)</code> -&gt; <code class="highlighter-rouge">Encrypted email</code></p>
</blockquote>

<hr />

<blockquote>
  <p>Let’s say you’re web server’s threat modal is different than that described
by <code class="highlighter-rouge">Scenario one</code> and your server still needs to respond to threats in <em>near</em>
real time via Fail2Ban but you still don’t wish to make it easy on future
attackers to access your server’s logs. In the following example we’ll be
setting up a pipe to pipe encryption of logs such that they only exist in plan
text long enough for monitoring software to do it’s thing.</p>
</blockquote>

<h2 id="generate-server-only-key-pare-on-host-file-system">Generate server only key pare on host file system</h2>

<blockquote>
  <p>Note not on the chrooted web server’s file system</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>gpg --homedir /tmp/.gnupg --gen-key
# Follow the prompts and set solid passphrase.
</code></pre>
</div>

<h2 id="export-the-servers-revocation-cert">Export the server’s revocation cert</h2>

<blockquote>
  <p>Note you’ll want to move this file off server if generating keys on the
same server that will also service clients because when your server becomes
compromised this cert will allow you to revoke these keys if they’re ever
uploaded to a key server.</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>gpg --homedir /tmp/.gnupg --gen-revoke --output /tmp/.gnupg/server_gpg_revoke.asci
</code></pre>
</div>

<h2 id="export-the-servers-public-key">Export the server’s public key</h2>

<blockquote>
  <p>This is for importation within host server file system.</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>gpg --homedir /tmp/.gnupg --export --output /tmp/.gnupg/server_public.key
</code></pre>
</div>

<h2 id="export-the-servers-privet-key">Export the server’s privet key</h2>

<blockquote>
  <p>back this up on another device using same transmission methods as
transmitting revoke cert. But we’ll also need to import this key to the
server’s host file system so don’t shred it just yet.</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>gpg --homedir /tmp/.gnupg --export-secret-keys --output /tmp/.gnupg/server_secret.key
</code></pre>
</div>

<h2 id="import-web-servers-private-key-to-hosts-keyring">Import web server’s private key to host’s keyring</h2>

<blockquote>
  <p>This will also import the public key so login to the user account you will
have running the pipe listening scripts prior to the following command; ie
the one defined by <code class="highlighter-rouge">--enc-copy-save-ownership="notwwwuser:notwwwgroup"</code>
command line option in next section.</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>gpg --import /tmp/.gnupg/server_secret.key
</code></pre>
</div>

<h2 id="or-using-su-for-notwwwuser-user">Or using <code class="highlighter-rouge">su</code> for <code class="highlighter-rouge">notwwwuser</code> user</h2>

<blockquote>
  <p>(the same as owner of parsing pipe listeners) command key import without
having to login that user.</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>su notwwwuser -c "gpg --import /tmp/.gnupg/server_secret.key"
</code></pre>
</div>

<h2 id="remove-the-temp-home-directory-gnupg-has-been-using-for-key-generation">Remove the temp home directory GnuPG has been using for key generation</h2>

<blockquote>
  <p>Do this once you have backed up the privet key and revoke cert to another
device.</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>rm -Irf /tmp/.gnupg
</code></pre>
</div>

<h2 id="write-some-scripts-to-different-directories">Write some scripts to different directories</h2>

<blockquote>
  <p>When using the main script of this project; be sure to pay attention to the
differences in command line options used and not used between runs.</p>
</blockquote>

<h3 id="first-is-a-pipe-to-pipe-encryption-named-pipe-listening-script">First is a pipe to pipe encryption named pipe listening script</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>/script/path/script_name.sh --enc-copy-save-yn='yes'\
 --enc-copy-save-path="/jailer_scripts/website_host/Web_log_pipe_to_pipe_encrypter.sh"\
 --enc-copy-save-ownership="notwwwuser:notwwwgroup"\
 --enc-copy-save-permissions='100'\
 --debug-level='6'\
 --enc-parsing-quit-string='sOmE_rAnDoM_sTrInG_wItHoUt_SpAcEs_tHaT_iS_nOt_NoRmAlY_rEaD'\
 --log-level='0'\
 --enc-pipe-file="/jailed_servers/website_host/var/log/www/access.log.pipe"\
 --enc-pipe-ownership='notwwwuser:wwwgroup'\
 --enc-pipe-permissions='420'\
 --enc-parsing-output-file="/jailed_logs/website_host/www_access.pipe"\
 --enc-parsing-recipient="user@host.domain"\
 --enc-parsing-output-rotate-yn='no'\
 --enc-parsing-save-output-yn='yes'\
 --enc-parsing-bulk-output-dir="/jailed_logs/host_backups"\
 --enc-parsing-disown-yn='yes' --help
</code></pre>
</div>

<h3 id="second-pipe-will-decrypt">Second pipe will decrypt</h3>

<blockquote>
  <p>With a little modification, anything written to it’s listening pipe will
output to a log file that fail2ban and other log monitoring services may read.
Note the log rotation settings as stated may fill your email’s inbox but at
least your logs only live in plan text for a short time on the public server.</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>/script/path/script_name.sh --dec-copy-save-yn='yes'\
 --dec-copy-save-path="/jailer_scripts/website_host/Web_log_pipe_to_pipe_decrypter.sh"\
 --dec-copy-save-ownership="notwwwuser:notwwwgroup"\
 --dec-copy-save-permissions='100'\
 --dec-pass="private-key-passphrase-or-file-path-to-passphrase"\
 --debug-level='6'\
 --log-level='0'\
 --dec-pipe-file="/jailed_logs/website_host/www_access.pipe"\
 --dec-pipe-ownership='notwwwuser:wwwgroup'\
 --dec-pipe-permissions='420'\
 --dec-parsing-save-output-yn='yes'\
 --dec-parsing-output-file="/jailed_logs/website_host/www_access.log"\
 --dec-parsing-quit-string='SoMe_rAnDoM_sTrInG_wItHoUt_SpAcEs_tHaT_iS_nOt_NoRmAlY_rEaD'\
 --enc-parsing-output-file="/jailed_logs/website_host/www_access.pipe"\
 --enc-parsing-bulk-output-dir="/jailed_logs/host_backups"\
 --dec-parsing-disown-yn='yes' --help
</code></pre>
</div>

<h4 id="start-stop-lines-for-decryption-pipe-to-log-file">Start stop lines for decryption pipe to log file</h4>

<div class="highlighter-rouge"><pre class="highlight"><code># Start decryption pipe listener
/jailer_scripts/website_host/Web_log_pipe_to_pipe_decrypter.sh
# Stop decryption pipe listener
echo 'SoMe_rAnDoM_sTrInG_wItHoUt_SpAcEs_tHaT_iS_nOt_NoRmAlY_rEaD' &gt; /jailed_servers/website_host/var/log/www/access.log.pipe
</code></pre>
</div>

<h4 id="start-stop-lines-for-encryption-pipe-to-pipe-files">Start stop lines for encryption pipe to pipe files</h4>

<div class="highlighter-rouge"><pre class="highlight"><code>## Start encryption pipe listener
/jailer_scripts/website_host/Web_log_pipe_to_pipe_encrypter.sh
# Stop decryption pipe listener
echo 'sOmE_rAnDoM_sTrInG_wItHoUt_SpAcEs_tHaT_iS_nOt_NoRmAlY_rEaD' &gt; /jailed_logs/website_host/www_access.pipe
</code></pre>
</div>

<h2 id="notes-on-differences-between-written-scripts-options-used-above">Notes on differences between written script’s options used above</h2>

<h3 id="input---output-first-script-options">Input -&gt; output first script options</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>--enc-pipe-file="/jailed_servers/website_host/var/log/www/access.log.pipe" \
--enc-parsing-output-file="/jailed_logs/website_host/www_access.pipe" \
</code></pre>
</div>

<h3 id="input---output-second-script-options">Input -&gt; output second script options</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>--enc-pipe-file="/jailed_logs/website_host/www_access.pipe" \
--enc-parsing-output-file="/jailed_logs/website_host/www_access.log" \
</code></pre>
</div>

<blockquote>
  <p>Above outlines taking input written by web server logging service on pipe
<code class="highlighter-rouge">/jailed_servers/website_host/var/log/www/access.log.pipe</code> putting through
encryption before outputting to pipe <code class="highlighter-rouge">/jailed_logs/website_host/www_access.pipe</code>
file that the second script is listening for lines to parse for decryption. Data
is passed through the second script’s decryption loops and output in clear text
file under <code class="highlighter-rouge">/jailed_logs/website_host/www_access.log</code> path.
Now some maybe wondering what the benefit of this type of set up is. Simply if
the second script dies then the first script will just make an encrypted log
under the same file path as the second script’s listening pipe; much like in
<code class="highlighter-rouge">Scenario one</code>’s usage example. And if at a latter time you wish to move
decryption to a separate physical server, ie over an VPN or SSH connection, then
you’ll only need to move the second script and private key to begin setting up
pipe to pipe encrypted (doubly at that point) centralized log proxy decrypter…
the authors will cover this in another scenario further on.</p>
</blockquote>

<h3 id="input---output-pre-parsing-and-log-rotation-options-in-the-first-script">Input -&gt; output pre-parsing and log rotation options in the first script</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>--enc-parsing-filter-input-yn='yes' \
--enc-parsing-output-rotate-yn='no' \
--enc-parsing-save-output-yn='yes' \
</code></pre>
</div>

<h3 id="input---output-pre-parsing-and-log-rotation-options-in-the-second-script">Input -&gt; output pre-parsing and log rotation options in the second script</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>--enc-parsing-filter-input-yn='no' \
--enc-parsing-output-rotate-actions='compress-encrypt,remove-old' \
--enc-parsing-output-check-frequency='250' \
--enc-parsing-output-max-size='8046' \
--enc-parsing-output-rotate-recipient="user@host.domain" \
--enc-parsing-output-rotate-yn='yes' \
--enc-parsing-save-output-yn='yes' \
</code></pre>
</div>

<blockquote>
  <p>Above we’re disabling the log rotation for the first script because it’s
<em>log</em> file is really the listening pipe of the second script, thus we really
don’t want the first script trying to preform log rotate actions on a named
pipe. And we’re setting low values for the log rotation of the second script
to keep clear text versions of or logs from kicking around on the host’s file
system for any longer than they need to be, however, this will cause your web
or sys admin’s email to become quite full unless they’ve setup some form of
auto retrieval script to handle the traffic automatically. This is a balance
your team must strike between threat modal vs administrating the log shuffle
over-head described. The <code class="highlighter-rouge">--enc-parsing-filter-input-yn='</code><em>yes/no</em><code class="highlighter-rouge">'</code> option
differences between first and second scripts are; in the first script we set
this to <code class="highlighter-rouge">yes</code> to restrict what input is read and encrypted, and in the second
script to prevent GnuPG decryption from failing to decrypt we set this to <code class="highlighter-rouge">no</code>
and read raw lines in.</p>
</blockquote>

<h2 id="licensing-notice-for-this-file">Licensing notice for this file</h2>

<div class="highlighter-rouge"><pre class="highlight"><code>    Copyright (C) 2016 S0AndS0.
    Permission is granted to copy, distribute and/or modify this document under
    the terms of the GNU Free Documentation License, Version 1.3 published by
    the Free Software Foundation; with the Invariant Sections being
    "Title page". A copy of the license is included in the directory entitled
    "License".
</code></pre>
</div>

<p><a href="/Documentation/Contributing_Financially.html">Link to title page</a></p>

<p><a href="/Licenses/GNU_FDLv1.3_Documentation.html">Link to related license</a></p>

      </section>
    </div>

    
  </body>
</html>
