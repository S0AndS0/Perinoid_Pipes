<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link rel="stylesheet" href="/assets/css/style.css?v=0c3df73b4b0f422ddbf3bcf68ad33f41f6f353e2">
    <title>Perinoid_Pipes by S0AndS0</title>
  </head>

  <body>

    <header>
      <div class="container">
        <h1>Perinoid_Pipes</h1>
        <h2>Where named pipes are used for encryption</h2>

        <section id="downloads">
          
          <a href="http://github.com/S0AndS0/Perinoid_Pipes" class="btn btn-github"><span class="icon"></span>View on GitHub</a>
        </section>
      </div>
    </header>

    <div class="container">
      <section id="main_content">
        <h1 id="scenario-four">Scenario Four</h1>

<hr />

<blockquote>
  <p>Logging output <code class="highlighter-rouge">-&gt;</code> Named Pipe encryption input file <code class="highlighter-rouge">-&gt;</code>
Encrypt &amp; send output to <code class="highlighter-rouge">-&gt;</code> Pipe decryption input file <code class="highlighter-rouge">-&gt;</code>
Mount decryption input file directory via SSHfs <code class="highlighter-rouge">-&gt;</code>
Start listener on remote mounted Pipe decryption input file <code class="highlighter-rouge">-&gt;</code>
Log decrypted output <code class="highlighter-rouge">-&gt;</code> On rotate send encrypted email</p>
</blockquote>

<hr />

<blockquote>
  <p>This scenario is an <em>extension</em> of the usage model explained within
<a href="/Documentation/Paranoid_Pipes_Scenario_Two.html">Paranoid_Pipes_Scenario_Two.md</a> documentation,
Use <code class="highlighter-rouge">sshfs</code> to mount your remote’s (web server’s logging) directory, start
decryption named pipe listener on local system listening to where the
remote’s encryption output will be sent, then start the remote’s encrypting
named pipe service to output to the shared (<code class="highlighter-rouge">sshfs</code> mounted) named pipe file.
So long as your head isn’t spinning from that and the file paths are correct,
then like magic your remote’s logs will be saved on the local file system in
plan text for a finite time prior to being re-encrypted and sent to an email
account for archival. The <em>sweet</em> part of this setup is a disconnect from the
remote or local side of <code class="highlighter-rouge">sshfs</code> will cause logs to be saved on the remote’s
file system in an encrypted format</p>
</blockquote>

<h2 id="setup-local-server">Setup local server</h2>

<h3 id="install-additional-dependencies-on-local-server">Install additional dependencies on local server</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>sudo apt-get install sshfs
</code></pre>
</div>

<h3 id="generate-ssh-key-pair-on-local-server">Generate ssh key pair on local server</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>Var_sshfs_user="s0ands0"
## Make a directory and move there for key generation
mkdir -p ~/.ssh_fs
cd ~/.ssh_fs
## Generate key pair of specified name
ssh-keygen -t rsa -b 4096 -f ${Var_sshfs_user}
## Copy public key to local tmp directory
cp ${Var_sshfs_user}.pub /tmp/${Var_sshfs_user}.pub
## Save that path to a variable for latter use
Var_ssh_pubkey="/tmp/${Var_sshfs_user}.pub"
</code></pre>
</div>

<h3 id="configure-ssh-client-settings-on-local-server">Configure <code class="highlighter-rouge">ssh</code> client settings on local server</h3>

<blockquote>
  <p>Set some variables, note, the <code class="highlighter-rouge">Var_ssh_host</code> variable will be used latter
within this document.</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>Var_ssh_conf="/etc/ssh/ssh_conf"
Var_ssh_host="Web_Host"
Var_ssh_hostname="192.168.0.3"
Var_ssh_user="notsudo"
</code></pre>
</div>

<blockquote>
  <p>Note the following redirection will append to your ssh configs so long as you
remember the number of greater/less-then signs required.</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>sudo cat &gt;&gt; "${Var_ssh_conf}" &lt;&lt;EOF
Host ${Var_ssh_host}
    Hostname ${Var_ssh_hostname}
    User ${Var_ssh_user}
    IdentityFile ~/.ssh_fs/${Var_sshfs_user}
EOF
</code></pre>
</div>

<h3 id="clone-project-on-local-server">Clone project on local server</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>mkdir ~/git_clones
cd ~/git_clones
git clone https://github.com/S0AndS0/Perinoid_Pipes
cd Perinoid_Pipes
</code></pre>
</div>

<h3 id="generate-gnupg-key-pair-on-local-server">Generate GnuPG key pair on local server</h3>

<blockquote>
  <p>Set some variables, note, the <code class="highlighter-rouge">Var_gnupg_pubkey_file</code> variable will be used
latter within this document</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>Var_gnupg_email="user@host.domain"
Var_gnupg_pubkey_file="/tmp/${Var_gnupg_email//[@.]/}"
</code></pre>
</div>

<blockquote>
  <p>Make directory for GnuPG key revoke cert to be save to and <code class="highlighter-rouge">cd</code> to it.</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>mkdir ~/.gpg_remote_pair
cd ~/.gpg_remote_pair
</code></pre>
</div>

<blockquote>
  <p>Allow executable permissions for current running user to the following helper
script.</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>chmod u+x Script_Helpers/GnuPG_Gen_Key.sh
</code></pre>
</div>

<blockquote>
  <p>Print available command line options and their default settings. Note add
‘–help’ at the end to double check your own custom settings.</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>Script_Helpers/GnuPG_Gen_Key.sh --help
</code></pre>
</div>

<blockquote>
  <p>Run the helper script with the following defined options.</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>Script_Helpers/GnuPG_Gen_Key.sh\
 --prompt-for-pass-yn='yes'\
 --gnupg-email="${Var_gnupg_email}"\
 --gnupg-export-public-key-yn='yes'\
 --gnupg-export-public-key-location="${Var_gnupg_pubkey_file}"\
 --help
</code></pre>
</div>

<blockquote>
  <p>Remove <code class="highlighter-rouge">--help</code> from above to accept default and customized
options. Note that by setting <code class="highlighter-rouge">--prompt-for-pass-yn</code> to <code class="highlighter-rouge">yes</code>
will cause the script to request a passphrase be generated.</p>
</blockquote>

<h2 id="setup-remote-server">Setup remote server</h2>

<h3 id="setup-up-sftp-usergroup-on-remote">Setup up SFTP <code class="highlighter-rouge">user:group</code> on remote</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>Var_sftp_user="enclogger"
Var_sftp_group="sftplogger"
## Add new user and group for restrictions
adduser ${Var_sftp_user}
groupadd ${Var_sftp_group}
## Add new user to new group
usermod -a -G ${Var_sftp_group} ${Var_sftp_user}
## Lock the new user from logins
passwd -l ${Var_sftp_user}
## Lock the new user from shell access
usermod -s /bin/false ${Var_sftp_user}
</code></pre>
</div>

<h3 id="setup-chroot-directory-for-new-user-on-remote">Setup <code class="highlighter-rouge">chroot</code> directory for new user on remote</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>Var_sftp_chroot="/sftp/logger"
## Make base of chroot dir owned by root
mkdir -p ${Var_sftp_chroot}
chown root:root ${Var_sftp_chroot}
chmod 0754 ${Var_sftp_chroot}
## Make spicific directory that new user may read/write to
mkdir -p ${Var_sftp_chroot}/${Var_sftp_user}
chown ${Var_sftp_chroot}:${Var_sftp_user} ${Var_sftp_chroot}/${Var_sftp_user}
chmod 0764 ${Var_sftp_chroot}/${Var_sftp_user}
</code></pre>
</div>

<h3 id="append-configs-for-ssh-server-on-remote">Append configs for ssh server on remote</h3>

<blockquote>
  <p>Note you’ll need to manually edit the bellow file to ensure that the following
line is set correctly for <code class="highlighter-rouge">Subsystem</code> global settings; above the next block.</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>Subsystem    sftp    internal-sftp
</code></pre>
</div>

<blockquote>
  <p>Configuration block for new sftp user group</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>Var_sshd_conf="/etc/ssh/sshd_conf"
cat &gt;&gt; "${Var_sshd_conf}" &lt;&lt;EOF
Match Group ${Var_sftp_group}
    ChrootDirectory ${Var_sftp_chroot}
    ForceCommand internal-sftp
    AllowTcpForwarding no
EOF
</code></pre>
</div>

<blockquote>
  <p>Note that the remote’s ssh server should be restarted &amp;/or reloaded after any
configuration changes. Additionally for remote servers it’s a good idea to
open a second local terminal and re-connect. <strong>without</strong> disconecting the
first, to test that settings haven’t been buggered up.</p>
</blockquote>

<h2 id="setup-named-pipe--mount-points">Setup named pipe &amp; mount points</h2>

<h3 id="copy-local-ssh-public-key-to-remote">Copy local ssh public key to remote</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>Var_ssh_command="mkdir -p /home/${Var_ssh_user}; cat &gt;&gt; /home/${Var_ssh_user}/.ssh/authorized_keys"
cat ${Var_ssh_pubkey} | ssh root@${Var_ssh_hostname} "${Var_ssh_command}"
</code></pre>
</div>

<h3 id="mount-remote-directory-to-local">Mount remote directory to local</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>Var_mount_point="/mnt/"
## Make a mount point on local
mkdir -p ${Var_mount_point}
## Mount via sshfs
sshfs ${Var_ssh_host}:/ ${Var_mount_point}
</code></pre>
</div>

<h3 id="copy-gnupg-public-key-to-remote-mount-point">Copy GnuPG public key to remote mount point</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>cp ${Var_gnupg_pubkey_file} ${Var_mount_point}/${Var_ssh_user}
</code></pre>
</div>

<h3 id="setup-named-pipe-listener-for-decryption-on-local">Setup named pipe listener for decryption on local</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>/script/path/script_name.sh --enc-copy-save-yn='yes'\
 --enc-copy-save-path="/jailer_scripts/website_host/Web_log_pipe_to_pipe_decrypter.sh"\
 --enc-copy-save-ownership="notwwwuser:notwwwgroup"\
 --enc-copy-save-permissions='100'\
 --debug-level='6'\
 --enc-parsing-quit-string='SoMe_rAnDoM_sTrInG_wItHoUt_SpAcEs_tHaT_iS_nOt_NoRmAlY_rEaD'\
 --log-level='0'\
 --enc-pipe-file="${Var_mount_point}/website_host/www_access.pipe"\
 --enc-pipe-ownership='notwwwuser:wwwgroup'\
 --enc-pipe-permissions='420'\
 --enc-parsing-output-file="/jailed_logs/website_host/www_access.log"\
 --enc-parsing-recipient="user@host.domain"\
 --enc-parsing-output-rotate-actions='compress-encrypt,remove-old'\
 --enc-parsing-output-check-frequency='250'\
 --enc-parsing-output-max-size='8046'\
 --enc-parsing-output-rotate-recipient="user@host.domain"\
 --enc-parsing-output-rotate-yn='yes'\
 --enc-parsing-save-output-yn='yes'\
 --enc-parsing-disown-yn='yes' --help
</code></pre>
</div>

<h3 id="setup-named-pipe-for-remote-server-encryption">Setup named pipe for remote server encryption</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>/script/path/script_name.sh --enc-copy-save-yn='yes'\
 --enc-copy-save-path="${Var_mount_point}/website_host/Web_log_pipe_to_pipe_encrypter.sh"\
 --enc-copy-save-ownership="notwwwuser:notwwwgroup"\
 --enc-copy-save-permissions='100'\
 --debug-level='6'\
 --enc-parsing-quit-string='sOmE_rAnDoM_sTrInG_wItHoUt_SpAcEs_tHaT_iS_nOt_NoRmAlY_rEaD'\
 --log-level='0'\
 --enc-pipe-file="${Var_sftp_chroot}/website_host/var/log/www/access.log.pipe"\
 --enc-pipe-ownership='notwwwuser:wwwgroup'\
 --enc-pipe-permissions='420'\
 --enc-parsing-output-file="${Var_sftp_chroot}/website_host/www_access.pipe"\
 --enc-parsing-recipient="${Var_gnupg_email}"\
 --enc-parsing-output-rotate-actions='compress-encrypt,remove-old'\
 --enc-parsing-output-check-frequency='250'\
 --enc-parsing-output-max-size='8046'\
 --enc-parsing-output-rotate-recipient="user@host.domain"\
 --enc-parsing-output-rotate-yn='yes'\
 --enc-parsing-save-output-yn='yes'\
 --enc-parsing-disown-yn='yes' --help
</code></pre>
</div>

<h2 id="licensing-notice-for-this-file">Licensing notice for this file</h2>

<div class="highlighter-rouge"><pre class="highlight"><code>    Copyright (C) 2016 S0AndS0.
    Permission is granted to copy, distribute and/or modify this document under
    the terms of the GNU Free Documentation License, Version 1.3 published by
    the Free Software Foundation; with the Invariant Sections being
    "Title page". A copy of the license is included in the directory entitled
    "License".
</code></pre>
</div>

<p><a href="/Documentation/Contributing_Financially.html">Link to title page</a></p>

<p><a href="/Licenses/GNU_FDLv1.3_Documentation.html">Link to related license</a></p>


      </section>
    </div>

    
  </body>
</html>
